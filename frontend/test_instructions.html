<!DOCTYPE html>
<html>
<head>
    <title>{{ test.test_name }} - Instructions</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="p-4">

<div class="container">

    <h2>{{ test.test_name }} - Instructions</h2>
    <hr>

    <p><b>Total Marks:</b> {{ test.total_marks }}</p>
    <p><b>Duration:</b> {{ test.duration_minutes }} minutes</p>
    <p><b>Total Questions:</b> {{ questions|length }}</p>

    <div class="alert alert-info">
       <b>Important Instructions ‚Äî Please Read Carefully</b><br><br>

       ‚Ä¢ Your test will start in <b>fullscreen mode</b> immediately.<br>
       ‚Ä¢ You must stay in fullscreen for the entire duration of the test.<br>
       ‚Ä¢ If you exit fullscreen <b>even once</b>, the test will be <b>terminated immediately</b>.<br>
       ‚Ä¢ Before starting, you must <b>allow camera access</b>. If camera permission is denied, the test will not start.<br>
       ‚Ä¢ Clicking ‚ÄúCancel‚Äù, closing the tab, switching apps, or leaving fullscreen will <b>end the test instantly</b>.<br>
       ‚Ä¢ The given time will continue to run. Failing to complete within the allotted time will <b>auto-submit</b> your test.<br>
    </div>

    <button class="btn btn-primary" id="acceptBtn">Accept</button>
</div>


<script>
document.getElementById("acceptBtn").addEventListener("click", async function (e) {

    console.log("CLICK DETECTED ‚Üí requesting fullscreen");

    try {
        // ‚≠ê FULLSCREEN FIRST
        await document.documentElement.requestFullscreen();
        console.log("FULLSCREEN ACTIVATED");

    } catch (err) {
        console.log("FULLSCREEN ERROR:", err);
        alert("Fullscreen Blocked: " + err);
        return;
    }

    console.log("Starting test session...");

    // ‚≠ê START TEST SESSION ‚Äî INCLUDING NAME + EMAIL
    const fd = new FormData();
    fd.append("test_id", "{{ test.id }}");

    // üî• Add candidate name + email (hidden fields)
    fd.append("candidate_name", "{{ candidate_name }}");
    fd.append("candidate_email", "{{ candidate_email }}");

    const res = await fetch("/test/start-session", {
        method: "POST",
        body: fd
    });

    const data = await res.json();

    if (!data.success) {
        alert("Error: " + data.error);
        return;
    }

    const sid = data.submission_id;

    // ‚≠ê THE SECRET TRICK:
    setTimeout(() => {
        console.log("Redirecting while in fullscreen");
        location.href = `/test/fullscreen/{{ test.id }}?sid=${sid}`;
    }, 10);

});
</script>

</body>
</html>
